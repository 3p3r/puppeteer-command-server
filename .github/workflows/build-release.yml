name: Build and Release

on:
  push:
    branches: 
      - 'main'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build All Platforms
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup LLVM
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "14"

      - name: Install dependencies
        run: npm ci
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"

      - name: Bundle application
        run: npm run bundle
      
      - name: Run tests
        uses: mujo-code/puppeteer-headful@bc2b5958b7446b44440b8a4f2ff40c0ce308f5ad
        env:
          CI: "true"
        with:
          args: npm test

      - name: Build Linux first (to populate cache)
        run: npm run compile -- --linux --fast

      - name: Rebuild (full build)
        run: npm run build

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: pcs-windows
          path: build/min/win/pcs.exe
          retention-days: 7

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: pcs-linux
          path: build/min/linux/pcs
          retention-days: 7

      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: pcs-macos
          path: build/min/mac/pcs
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release binaries
        run: |
          mkdir -p release
          # Copy Windows binary (already named pcs.exe)
          cp artifacts/pcs-windows/pcs.exe release/pcs.exe
          # Copy and rename Linux binary
          cp artifacts/pcs-linux/pcs release/pcs-linux
          # Copy and rename macOS binary
          cp artifacts/pcs-macos/pcs release/pcs-macos
          # Verify files exist and set permissions
          ls -lah release/
          chmod +x release/pcs-linux release/pcs-macos

      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          files: |
            release/pcs.exe
            release/pcs-linux
            release/pcs-macos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

